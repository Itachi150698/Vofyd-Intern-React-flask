{% extends"base.html" %}

{% block content %}


<h1>Dashboard</h1>
<button onclick="logout()">Logout</button>
    <h2>Super Admin Dashboard</h2>
    <h3>Super Admin Profile</h3>
    
    <div id="superAdminProfile">
        <p><strong>Full Name:</strong> <span id="profile_full_name"></span></p>
        <p><strong>Username:</strong> <span id="profile_username"></span></p>
        <p><strong>Email:</strong> <span id="profile_email"></span></p>
        <p><strong>Phone:</strong> <span id="profile_phone"></span></p>
        <p><strong>Organization Name:</strong> <span id="profile_organization_name"></span></p>
        <p><strong>Organization ID:</strong> <span id="profile_organization_id"></span></p>
        <p><strong>Role:</strong> <span id="profile_role"></span></p>
        <p><strong>Status:</strong> <span id="profile_status"></span></p>
    </div>
    

    
    <h3>Admin Users</h3>
    <table border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>Full Name</th>
                <th>Username</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Role</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="adminTableBody">
            <!-- Admin users will be populated here -->
        </tbody>
    </table>
    
    <h3>Add Admin User</h3>
    

    <form id="addAdminForm">
        <input type="text" id="full_name" placeholder="Full Name" required>
        <input type="text" id="username" placeholder="Username" required>
        <input type="email" id="email" placeholder="Email" required>
        <input type="text" id="phone_number" placeholder="Phone Number" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit">Add Admin</button>
    </form>
    

    <!-- Update Admin Modal -->
<!-- Update Admin Modal -->
<div id="updateAdminModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background: white; border: 1px solid black;">
    <h3>Update Admin User</h3>
    <form id="updateAdminForm">
        <input type="hidden" id="update_id">
        <input type="text" id="update_full_name" placeholder="Full Name" required>
        <input type="text" id="update_username" placeholder="Username" required>
        <input type="email" id="update_email" placeholder="Email" required>
        <input type="text" id="update_phone_number" placeholder="Phone Number" required>
        
        <!-- Status Dropdown -->
        <select id="update_status" required>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
            <option value="Suspended">Suspended</option>
        </select>

        <button type="submit">Update</button>
        <button type="button" onclick="closeUpdateModal()">Cancel</button>
    </form>
</div>




    <script>
        document.addEventListener("DOMContentLoaded", function() {
            fetchAdmins();
        });

        function fetchAdmins() {
            fetch("/admin/list_users")
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById("adminTableBody");
                    tableBody.innerHTML = "";
                    data.users.forEach(user => {
                        const row = `<tr>
                            <td>${user.id}</td>
                            <td>${user.full_name}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>${user.phone_number}</td>
                            <td>${user.role}</td>
                            <td>${user.status}</td>
                            <td>
                                <button onclick="editAdmin(${user.id}, '${user.full_name}', '${user.username}', '${user.email}', '${user.phone_number}')">Update</button>
                                <button onclick="deleteAdmin(${user.id})">Delete</button>
                            </td>

                        </tr>`;
                        tableBody.innerHTML += row;
                    });
                });
        }

        document.getElementById("addAdminForm").addEventListener("submit", function(event) {
            event.preventDefault();
            const adminData = {
                full_name: document.getElementById("full_name").value,
                username: document.getElementById("username").value,
                email: document.getElementById("email").value,
                phone_number: document.getElementById("phone_number").value,
                password: document.getElementById("password").value,
                status: "Active"
            };

            fetch("/admin/add_user", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(adminData)
            })
            .then(response => response.json())
            .then(() => {
                fetchAdmins();
                document.getElementById("addAdminForm").reset();
            });
        });

        function deleteAdmin(userId) {
            fetch(`/admin/delete_user/${userId}`, { method: "DELETE" })
                .then(() => fetchAdmins());
        }

        function logout() {
            fetch("/auth/logout", { method: "POST" })
                .then(response => {
                    if (response.ok) {
                        window.location.href = "/views/login_page"; // Redirect to login page after logout
                    } else {
                        alert("Logout failed!");
                    }
                })
                .catch(error => console.error("Error:", error));
        }


        function closeUpdateModal() {
            document.getElementById("updateAdminModal").style.display = "none";
        }
        

        function editAdmin(id, full_name, username, email, phone_number, status) {
            document.getElementById("update_id").value = id;
            document.getElementById("update_full_name").value = full_name;
            document.getElementById("update_username").value = username;
            document.getElementById("update_email").value = email;
            document.getElementById("update_phone_number").value = phone_number;
            document.getElementById("update_status").value = status; // Set status in dropdown
            document.getElementById("updateAdminModal").style.display = "block";
        }
        
        document.getElementById("updateAdminForm").addEventListener("submit", async function(event) {
            event.preventDefault();
        
            const updatedAdmin = {
                full_name: document.getElementById("update_full_name").value,
                username: document.getElementById("update_username").value,
                email: document.getElementById("update_email").value,
                phone_number: document.getElementById("update_phone_number").value,
                status: document.getElementById("update_status").value, // Capture status
            };
        
            const userId = document.getElementById("update_id").value;
        
            try {
                const response = await fetch(`/admin/update_user/${userId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedAdmin),
                });
        
                const result = await response.json(); // Await response before using it
                alert(result.message); // Show success or error message
        
                fetchAdmins(); // Refresh the admin list
                closeUpdateModal(); // Close the modal
                
            } catch (error) {
                console.error("Error:", error);
                alert("Failed to update user. Please try again.");
            }
        });
        


    
        function fetchSuperAdminProfile() {
            fetch("/admin/super_admin", { 
                method: "GET", 
                headers: { "Content-Type": "application/json" }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Unauthorized") {
                    console.error("Access denied");
                    return;
                }
        
                document.getElementById("profile_full_name").innerText = data.full_name;
                document.getElementById("profile_username").innerText = data.username;
                document.getElementById("profile_email").innerText = data.email;
                document.getElementById("profile_phone").innerText = data.phone_number;
                document.getElementById("profile_organization_name").innerText = data.organization_name;
                document.getElementById("profile_organization_id").innerText = data.organization_id;
                document.getElementById("profile_role").innerText = data.role;
                document.getElementById("profile_status").innerText = data.status;
            })
            .catch(error => console.error("Error fetching Super Admin profile:", error));
        }
        
        // Call the function when the page loads
        document.addEventListener("DOMContentLoaded", function() {
            fetchSuperAdminProfile();
        });
        



    </script>

{% endblock %}